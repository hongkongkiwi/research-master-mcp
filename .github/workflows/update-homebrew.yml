name: Update Homebrew Formula

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 0.1.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION"

      - name: Download release artifacts
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          echo "Downloading artifacts for version $VERSION"
          mkdir -p artifacts

          # Download macOS x86_64 binary (for checksum)
          gh release download "v$VERSION" --pattern "*macos-amd64*" --dir artifacts 2>/dev/null || echo "No macos-amd64 artifacts found"

          # Download macOS ARM64 binary (for checksum)
          gh release download "v$VERSION" --pattern "*macos-arm64*" --dir artifacts 2>/dev/null || echo "No macos-arm64 artifacts found"

          # Download Linux x86_64 binary
          gh release download "v$VERSION" --pattern "*linux-amd64*" --dir artifacts 2>/dev/null || echo "No linux-amd64 artifacts found"

          # Download source archive
          gh release download "v$VERSION" --pattern "*.tar.gz" --dir artifacts 2>/dev/null || echo "No tar.gz artifacts found"

          ls -la artifacts/

      - name: Calculate checksums
        id: checksums
        run: |
          cd artifacts
          if ls *.tar.gz 1> /dev/null 2>&1; then
            SHA256=$(sha256sum *.tar.gz | head -1 | awk '{print $1}')
            echo "sha256=\"$SHA256\"" >> $GITHUB_OUTPUT
          else
            echo "sha256=\"\"" >> $GITHUB_OUTPUT
          fi

      - name: Clone Homebrew repository
        env:
          HOMEBREW_TOKEN: ${{ secrets.HOMEBREW_UPDATE_TOKEN }}
        run: |
          git clone https://x-access-token:${HOMEBREW_TOKEN}@github.com/hongkongkiwi/homebrew-research-master-mcp.git
          cd homebrew-research-master-mcp
          ls -la

      - name: Update formula
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
          SHA256: ${{ steps.checksums.outputs.sha256 }}
        run: |
          cd homebrew-research-master-mcp
          FORMULA_FILE="Formula/research-master-mcp.rb"

          # Create new formula content with actual values
          cat > "$FORMULA_FILE" << FORMULA_EOF
  # Documentation: https://github.com/hongkongkiwi/research-master-mcp/blob/main/README.md
  class ResearchMasterMcp < Formula
    desc "MCP server for searching and downloading academic papers from multiple research sources"
    homepage "https://github.com/hongkongkiwi/research-master-mcp"
    url "https://github.com/hongkongkiwi/research-master-mcp/archive/refs/tags/v${VERSION}.tar.gz"
    sha256 "${SHA256}"
    license "MIT"

    depends_on "poppler"

    def install
      system "cargo", "install", "--no-track", "--bin-names", "research-master-mcp", "--root", prefix, "--path", "."
    end

    def test
      system "#{bin}/research-master-mcp", "--help"
    end
  end
  FORMULA_EOF

          echo "Updated formula:"
          cat "$FORMULA_FILE"

      - name: Commit and push to Homebrew repository
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
          HOMEBREW_TOKEN: ${{ secrets.HOMEBREW_UPDATE_TOKEN }}
        run: |
          cd homebrew-research-master-mcp
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Formula/research-master-mcp.rb
          git commit -m "Update research-master-mcp to v$VERSION"

          git push origin main

          echo "Homebrew formula updated successfully!"
